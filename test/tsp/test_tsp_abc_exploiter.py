import sys
from pathlib import Path

import numpy as np

sys.path.insert(0, str(Path(__file__).parent.parent.parent))

from RLOrchestrator.tsp.adapter import TSPAdapter
from RLOrchestrator.tsp.solvers.exploiters import TSPABCExploiter


def test_tsp_abc_exploiter_scout_phase_multiple_resets_no_none_fitness():
    """Regression: scout phase used to call min() after inserting unevaluated solutions."""
    np.random.seed(123)

    problem = TSPAdapter(num_cities=10, seed=123)
    exploiter = TSPABCExploiter(
        problem,
        population_size=8,
        limit=1,
        local_search_iter=1,
        seed=123,
    )
    exploiter.initialize()

    # Force multiple indices to trigger the scout phase in a single step.
    exploiter.trials = [exploiter.limit + 5] * len(exploiter.population)

    exploiter.step()

    assert all(sol.fitness is not None for sol in exploiter.population)
